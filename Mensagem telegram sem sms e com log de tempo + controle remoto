#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>

// ==================== Configuração Wi-Fi e Telegram ====================
const char* ssid = "Aec10";
const char* password = "4Tyv!/.s";
const char* botToken = "8288152844:AAFfMhSKBMunK68JkyogC5nKGL7vVGBhU3w";
String chatID = "6148205976";

// ==================== Entradas digitais ====================
const int entrada1 = 5;
const int entrada2 = 4;
const int entrada3 = 16;
const int entrada4 = 17;

// ==================== Saída digital ====================
const int saidaGerador = 18;

// ==================== Controle interno ====================
int ultimoCodigoConfirmado = -1;
int codigoAnteriorLeitura = -1;

unsigned long tempoMudanca = 0;
const unsigned long tempoEstabilizacao = 300;

unsigned long ultimoEnvioTelegram = 0;
const unsigned long tempoMinimoEntreEnvios = 500;

bool geradorLigado = false;
unsigned long tempoInicio = 0;

// ==================== Controle Telegram ====================
unsigned long ultimoCheckTelegram = 0;
const unsigned long intervaloCheckTelegram = 3000;
long lastUpdateId = 0;

void setup() {
  Serial.begin(115200);
  delay(1000);

  pinMode(entrada1, INPUT_PULLUP);
  pinMode(entrada2, INPUT_PULLUP);
  pinMode(entrada3, INPUT_PULLUP);
  pinMode(entrada4, INPUT_PULLUP);

  pinMode(saidaGerador, OUTPUT);
  digitalWrite(saidaGerador, LOW);

  Serial.println("Sistema iniciado com filtro de estabilidade");

  WiFi.begin(ssid, password);
  Serial.print("Conectando ao WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi conectado!");
}

void loop() {

  verificarComandosTelegram();

  // ==================== Leitura das entradas ====================
  int e1 = !digitalRead(entrada1);
  int e2 = !digitalRead(entrada2);
  int e3 = !digitalRead(entrada3);
  int e4 = !digitalRead(entrada4);

  int codigoAtual = (e1 << 3) | (e2 << 2) | (e3 << 1) | e4;

  if (codigoAtual != codigoAnteriorLeitura) {
    tempoMudanca = millis();
    codigoAnteriorLeitura = codigoAtual;
  }

  if ((millis() - tempoMudanca) > tempoEstabilizacao) {
    if (codigoAtual != ultimoCodigoConfirmado) {

      String estado = tabelaGerador(codigoAtual);

      Serial.println(estado);

      // ==================== Log tempo ligado ====================
      if (e1 == 1 && !geradorLigado) {
        geradorLigado = true;
        tempoInicio = millis();
      }
      else if (e1 == 0 && geradorLigado) {
        geradorLigado = false;

        unsigned long tempoLigadoMs = millis() - tempoInicio;
        unsigned long totalMinutos = tempoLigadoMs / 60000;
        unsigned long horas = totalMinutos / 60;
        unsigned long minutos = totalMinutos % 60;

        String mensagemTempo = "Gerador ficou ligado por ";
        if (horas > 0) mensagemTempo += String(horas) + " h ";
        mensagemTempo += String(minutos) + " min";

        enviarMensagemTelegram(mensagemTempo);
      }

      // Envio de estado
      if (millis() - ultimoEnvioTelegram > tempoMinimoEntreEnvios) {
        enviarMensagemTelegram(estado);
        ultimoEnvioTelegram = millis();
      }

      ultimoCodigoConfirmado = codigoAtual;
    }
  }
}

// ==================== Verificação comandos Telegram ====================
void verificarComandosTelegram() {

  if (millis() - ultimoCheckTelegram < intervaloCheckTelegram) return;
  ultimoCheckTelegram = millis();

  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  String url = "https://api.telegram.org/bot" + String(botToken) +
               "/getUpdates?offset=" + String(lastUpdateId + 1);
  http.begin(url);

  int httpCode = http.GET();

  if (httpCode == 200) {
    String payload = http.getString();

    DynamicJsonDocument doc(4096);
    deserializeJson(doc, payload);

    JsonArray results = doc["result"];

    for (JsonObject obj : results) {

      lastUpdateId = obj["update_id"].as<long>();

      if (!obj["message"]["text"]) continue;

      String mensagem = obj["message"]["text"].as<String>();
      mensagem.trim();

      if (mensagem == "Ligar gerador") {
        digitalWrite(saidaGerador, HIGH);
        enviarMensagemTelegram("Saida do gerador acionada.");
      }

      else if (mensagem == "Desligar gerador") {
        digitalWrite(saidaGerador, LOW);
        enviarMensagemTelegram("Saida do gerador desligada.");
      }
    }
  }

  http.end();
}

// ==================== Envio Telegram ====================
void enviarMensagemTelegram(String mensagem) {

  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  String url = "https://api.telegram.org/bot" + String(botToken) + "/sendMessage";
  http.begin(url);
  http.addHeader("Content-Type", "application/x-www-form-urlencoded");

  String postData = "chat_id=" + chatID + "&text=" + mensagem;
  http.POST(postData);

  http.end();
}

// ==================== Tabela lógica ORIGINAL COMPLETA ====================
String tabelaGerador(int codigo) {

  switch(codigo) {

    case 0b0000: return "Gerador desligado - QTA posicao 0";
    case 0b0001: return "Gerador desligado - QTA posicao II";
    case 0b0010: return "Gerador desligado - QTA posicao I";
    case 0b0011: return "Nao aplicado";

    case 0b0100: return "Gerador em falha - QTA posicao 0";
    case 0b0101: return "Gerador em falha - QTA posicao II";
    case 0b0110: return "Gerador em falha - QTA posicao I";
    case 0b0111: return "Nao aplicado";

    case 0b1000: return "Gerador ligado - QTA posicao 0";
    case 0b1001: return "Gerador ligado - QTA posicao II";
    case 0b1010: return "Gerador ligado - QTA posicao I";
    case 0b1011: return "Nao aplicado";

    case 0b1100: return "Gerador em alerta - QTA posicao 0";
    case 0b1101: return "Gerador em alerta - QTA posicao II";
    case 0b1110: return "Gerador em alerta - QTA posicao I";
    case 0b1111: return "Nao aplicado";

    default: return "Estado desconhecido";
  }
}
